#!/bin/bash

## 组件版本
export set_ver_nginx=1.26.2
export set_ver_openssl=3.3.2
export set_ver_zlib=1.3.1


## 依赖组件
echo "安装Nginx依赖组件..."
apt install -y openssl libxml2 sqlite libpcre2-dev
sleep 6

## 处理源码
cd /root/hazx/src
tar zxvf nginx-${set_ver_nginx}.tar.gz
tar zxvf openssl-${set_ver_openssl}.tar.gz
tar zxvf zlib-${set_ver_zlib}.tar.gz
cd /root/hazx/src/nginx-${set_ver_nginx}/

## 配置Nginx
echo "配置Nginx..."
./configure \
    --prefix=/web_server \
    --with-openssl=/root/hazx/src/openssl-${set_ver_openssl} \
    --with-zlib=/root/hazx/src/zlib-${set_ver_zlib} \
    --with-http_ssl_module \
    --with-http_sub_module \
    --with-http_stub_status_module \
    --with-http_secure_link_module \
    --with-pcre \
    --with-pcre-jit \
    --with-http_realip_module \
    --with-http_dav_module \
    --with-http_v2_module \
    --with-stream \
    --with-stream_ssl_module

## 修改特征
sed -i "s/\"Server\:\ \"\ NGINX_VER\ CRLF\;/\"Server\:\ ${set_server_name:-HMengine}\"\ CRLF\;/" src/http/ngx_http_header_filter_module.c
sed -i "s/<center>\"\ NGINX_VER\ \"<\/center>/<center>${set_server_name:-HMengine}<\/center>/" src/http/ngx_http_special_response.c
sed -i "s/nginx\:/${set_server_name:-HMengine}\:/" src/os/unix/ngx_setproctitle.c
sleep 6

## 编译Nginx
echo "开始编译Nginx..."
make -j${set_make_threads:-2}
make install
mv /web_server/sbin/nginx /web_server/sbin/fe
sleep 6

## 处理配置文件
rm -fr /web_server/conf
mv /root/hazx/conf /web_server/conf
mkdir -p /web_server/conf/vhost

## 处理默认网页文件
rm -fr /web_server/html
mv /root/hazx/html /web_server/html
sed -i "s/server_name_web/${set_server_name_page:-HMengine}/" /web_server/html/index.html


sleep 6

